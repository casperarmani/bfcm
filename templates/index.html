<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Analysis Chatbot</title>
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/static/styles.css" rel="stylesheet">
</head>
<body>
    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-md-8 mx-auto">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <button id="new-chat-button" class="btn btn-primary me-2">
                            <i class="fas fa-plus-circle"></i> New Chat
                        </button>
                        <button id="logout-button" class="btn btn-danger" style="display: none;">
                            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                    <h1 class="mb-0">
                        <i class="fas fa-robot"></i> Video Analysis Chatbot
                    </h1>
                </div>

                <div class="chat-session-container">
                    <div id="chat-container" class="mb-4">
                        <!-- Chat messages will appear here -->
                    </div>
                </div>

                <form id="chat-form" class="mb-4">
                    <div class="mb-3 position-relative">
                        <label for="message" class="form-label">Message</label>
                        <textarea class="form-control" id="message" rows="3" maxlength="1000" required></textarea>
                        <div class="character-count">
                            <span id="char-count">0</span>/1000
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="videos" class="form-label">
                            <i class="fas fa-film"></i> Upload Videos (optional)
                        </label>
                        <input type="file" class="form-control" id="videos" accept="video/*" multiple>
                    </div>
                    <div id="upload-info" class="mb-3 d-none">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> Selected files: <span id="file-count">0</span>
                            <div id="file-list" class="mt-2"></div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane"></i> Send
                    </button>
                </form>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="history-panel">
                    <h3><i class="fas fa-history"></i> Chat History</h3>
                    <div id="chat-history"></div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="history-panel">
                    <h3><i class="fas fa-video"></i> Video Analysis History</h3>
                    <div id="video-analysis-history"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // New Chat functionality
        document.getElementById('new-chat-button').addEventListener('click', function() {
            const chatContainer = document.getElementById('chat-container');
            chatContainer.innerHTML = ''; // Clear chat container
            
            // Add welcome message
            chatContainer.innerHTML = `
                <div class="chat-message bot">
                    <div class="message-content">
                        <i class="fas fa-robot message-icon"></i>
                        Hello! I'm ready to help you analyze videos. You can start a new conversation or upload a video for analysis.
                    </div>
                </div>
            `;
            
            // Clear the message input and file upload
            document.getElementById('message').value = '';
            document.getElementById('videos').value = '';
            document.getElementById('upload-info').classList.add('d-none');
            document.getElementById('char-count').textContent = '0';
        });

        // Character count functionality
        const messageInput = document.getElementById('message');
        const charCount = document.getElementById('char-count');
        const maxLength = 1000;

        messageInput.addEventListener('input', function() {
            const remaining = this.value.length;
            charCount.textContent = remaining;
            
            const charCountDiv = charCount.parentElement;
            charCountDiv.classList.remove('near-limit', 'at-limit');
            
            if (remaining >= maxLength * 0.9) {
                charCountDiv.classList.add('at-limit');
            } else if (remaining >= maxLength * 0.8) {
                charCountDiv.classList.add('near-limit');
            }
        });

        // Enhanced file upload preview
        document.getElementById('videos').addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            const fileCount = files.length;
            const uploadInfo = document.getElementById('upload-info');
            const fileList = document.getElementById('file-list');
            
            if (fileCount > 0) {
                document.getElementById('file-count').textContent = fileCount;
                fileList.innerHTML = '';
                
                files.forEach((file, index) => {
                    const fileInfo = validateFile(file);
                    const filePreview = document.createElement('div');
                    filePreview.className = 'file-preview';
                    
                    filePreview.innerHTML = `
                        <i class="fas fa-file-video file-icon"></i>
                        <div class="file-info">
                            <div>${file.name}</div>
                            <small class="text-muted">${fileInfo.size}</small>
                            ${!fileInfo.isValidType ? '<div class="text-danger">Invalid file type</div>' : ''}
                        </div>
                        <i class="fas fa-times remove-file" data-index="${index}"></i>
                    `;
                    
                    if (!fileInfo.isValidType) {
                        filePreview.classList.add('invalid-file');
                    }
                    
                    fileList.appendChild(filePreview);
                });
                uploadInfo.classList.remove('d-none');
                
                // Add remove file functionality
                document.querySelectorAll('.remove-file').forEach(button => {
                    button.addEventListener('click', function() {
                        const index = parseInt(this.dataset.index);
                        const dt = new DataTransfer();
                        const input = document.getElementById('videos');
                        
                        for (let i = 0; i < input.files.length; i++) {
                            if (i !== index) {
                                dt.items.add(input.files[i]);
                            }
                        }
                        
                        input.files = dt.files;
                        const event = new Event('change');
                        input.dispatchEvent(event);
                    });
                });
            } else {
                uploadInfo.classList.add('d-none');
            }
        });

        // Session management and API request handling
        let isRefreshing = false;
        let failedQueue = [];

        function processQueue(error, token = null) {
            failedQueue.forEach(prom => {
                if (error) {
                    prom.reject(error);
                } else {
                    prom.resolve(token);
                }
            });
            failedQueue = [];
        }

        async function refreshToken() {
            try {
                const response = await fetch('/refresh_token', {
                    method: 'POST',
                    credentials: 'include'
                });
                if (!response.ok) {
                    throw new Error('Token refresh failed');
                }
                return await response.json();
            } catch (error) {
                console.error('Error refreshing token:', error);
                throw error;
            }
        }

        async function handleApiRequest(url, options = {}) {
            try {
                const response = await fetch(url, {
                    ...options,
                    credentials: 'include'
                });

                if (response.status === 401) {
                    if (!isRefreshing) {
                        isRefreshing = true;
                        try {
                            await refreshToken();
                            isRefreshing = false;
                            processQueue(null);
                            // Retry the original request
                            return await fetch(url, {
                                ...options,
                                credentials: 'include'
                            });
                        } catch (error) {
                            isRefreshing = false;
                            processQueue(error);
                            window.location.href = '/login';
                            throw error;
                        }
                    } else {
                        // Wait for the token refresh
                        return new Promise((resolve, reject) => {
                            failedQueue.push({ resolve, reject });
                        }).then(() => {
                            return fetch(url, {
                                ...options,
                                credentials: 'include'
                            });
                        });
                    }
                }
                return response;
            } catch (error) {
                console.error('API request error:', error);
                throw error;
            }
        }

        // File validation
        const VALID_VIDEO_TYPES = ['video/mp4', 'video/mpeg', 'video/quicktime', 'video/x-msvideo'];
        
        function validateFile(file) {
            return {
                name: file.name,
                type: file.type,
                size: (file.size / (1024 * 1024)).toFixed(2) + " MB",
                isValidType: VALID_VIDEO_TYPES.includes(file.type)
            };
        }

        document.getElementById('chat-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const messageInput = form.querySelector('#message');
            const videoInput = form.querySelector('#videos');
            const files = Array.from(videoInput.files);
            
            const formData = new FormData();
            formData.append('message', messageInput.value);
            
            files.forEach((file, index) => {
                const fileInfo = validateFile(file);
                if (fileInfo.isValidType) {
                    formData.append('videos', file);
                }
            });

            try {
                form.classList.add('loading');
                const response = await handleApiRequest('/send_message', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.response) {
                    const chatContainer = document.getElementById('chat-container');
                    chatContainer.innerHTML += `
                        <div class="chat-message user">
                            <div class="message-content">
                                <i class="fas fa-user message-icon"></i>
                                ${messageInput.value}
                            </div>
                        </div>
                        <div class="chat-message bot">
                            <div class="message-content">
                                <i class="fas fa-robot message-icon"></i>
                                ${data.response}
                            </div>
                        </div>
                    `;
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }
                
                messageInput.value = '';
                videoInput.value = '';
                document.getElementById('upload-info').classList.add('d-none');
                await loadHistory();
            } catch (error) {
                console.error('Error:', error);
                const chatContainer = document.getElementById('chat-container');
                chatContainer.innerHTML += `
                    <div class="chat-message error">An error occurred. Please try again.</div>
                `;
            } finally {
                form.classList.remove('loading');
            }
        });

        async function loadHistory() {
            try {
                const [chatResponse, videoResponse] = await Promise.all([
                    handleApiRequest('/chat_history'),
                    handleApiRequest('/video_analysis_history')
                ]);

                if (!chatResponse.ok || !videoResponse.ok) {
                    throw new Error('One or more requests failed');
                }

                const [chatData, videoData] = await Promise.all([
                    chatResponse.json(),
                    videoResponse.json()
                ]);

                document.getElementById('chat-history').innerHTML = chatData.history.length > 0
                    ? chatData.history.map(msg => `
                        <div class="chat-history-item">
                            <div class="history-timestamp">
                                ${new Date(msg.TIMESTAMP).toLocaleString('en-US', { timeZone: 'UTC' })}
                            </div>
                            <div class="history-content">
                                <i class="fas fa-${msg.chat_type === 'bot' ? 'robot' : 'user'} history-icon"></i>
                                <div class="history-message">
                                    <strong>${msg.chat_type === 'bot' ? 'Chatbot' : 'You'}</strong>
                                    <div>${msg.message}</div>
                                </div>
                            </div>
                        </div>
                    `).join('')
                    : '<div class="alert alert-info">No chat history available</div>';
                
                document.getElementById('video-analysis-history').innerHTML = videoData.history.length > 0
                    ? videoData.history.map(analysis => `
                        <div class="video-analysis-item">
                            <div class="history-timestamp">
                                ${new Date(analysis.TIMESTAMP).toLocaleString('en-US', { timeZone: 'UTC' })}
                            </div>
                            <div class="history-content">
                                <i class="fas fa-video history-icon"></i>
                                <div class="history-message">
                                    <div class="video-file-name">${analysis.upload_file_name}</div>
                                    <div class="video-analysis-text">${analysis.analysis}</div>
                                </div>
                            </div>
                        </div>
                    `).join('')
                    : '<div class="alert alert-info">No video analysis history available</div>';
            } catch (error) {
                console.error('Error loading history:', error);
                const errorMessage = '<div class="alert alert-danger">Error loading history. Please refresh the page.</div>';
                document.getElementById('chat-history').innerHTML = errorMessage;
                document.getElementById('video-analysis-history').innerHTML = errorMessage;
            }
        }

        // Session keepalive
        function startSessionKeepalive() {
            setInterval(async () => {
                try {
                    const response = await handleApiRequest('/auth_status');
                    if (!response.ok) {
                        console.error('Session keepalive failed');
                    }
                } catch (error) {
                    console.error('Session keepalive error:', error);
                }
            }, 300000); // Ping every 5 minutes
        }

        // Check authentication status on page load
        checkAuthStatus();
        startSessionKeepalive();

        async function checkAuthStatus() {
            try {
                const response = await handleApiRequest('/auth_status');
                const data = await response.json();
                
                if (data.authenticated) {
                    document.getElementById('logout-button').style.display = 'block';
                    // Show welcome message in new chat
                    document.getElementById('new-chat-button').click();
                    await loadHistory();
                } else {
                    window.location.href = '/login';
                }
            } catch (error) {
                console.error('Auth status error:', error);
                window.location.href = '/login';
            }
        }
    </script>
</body>
</html>
