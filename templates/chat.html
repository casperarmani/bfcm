{% extends "base.html" %}

{% block title %}Chat - Video Analysis Chatbot{% endblock %}

{% block content %}
<div x-data="{ 
    message: '', 
    files: [],
    isLoading: false,
    updateFileList() {
        this.files = Array.from($refs.fileInput.files);
    }
}">
    <!-- Chat Container -->
    <div class="container mx-auto max-w-4xl">
        <!-- Chat Messages -->
        <div class="card bg-base-100 shadow-xl mb-4">
            <div class="card-body">
                <div id="chat-container" class="h-96 overflow-y-auto space-y-4 mb-4"
                     hx-get="/partials/chat-messages"
                     hx-trigger="load, newMessage from:body"
                     hx-swap="innerHTML">
                    <!-- Messages will be loaded here -->
                </div>
                
                <!-- Chat Input Form -->
                <form class="space-y-4"
                      @submit.prevent="isLoading = true"
                      hx-post="/send_message"
                      hx-encoding="multipart/form-data"
                      hx-trigger="submit"
                      hx-indicator="#loading-indicator"
                      hx-on::after-request="isLoading = false; message = ''; $refs.fileInput.value = ''; files = []"
                      hx-on::after-receive="document.body.dispatchEvent(new Event('newMessage'))">
                    
                    <!-- Message Input -->
                    <div class="form-control">
                        <textarea 
                            class="textarea textarea-bordered h-24"
                            x-model="message"
                            placeholder="Type your message here..."
                            name="message"
                            required></textarea>
                    </div>
                    
                    <!-- File Upload -->
                    <div class="form-control">
                        <input 
                            type="file"
                            class="file-input file-input-bordered w-full"
                            accept="video/*"
                            multiple
                            name="videos"
                            x-ref="fileInput"
                            @change="updateFileList()">
                        
                        <!-- File List -->
                        <div x-show="files.length > 0" class="mt-2">
                            <div class="alert alert-info">
                                <span x-text="'Selected files: ' + files.length"></span>
                                <ul class="mt-2 list-disc list-inside">
                                    <template x-for="file in files" :key="file.name">
                                        <li>
                                            <span x-text="file.name"></span>
                                            (<span x-text="(file.size / (1024 * 1024)).toFixed(2) + ' MB'"></span>)
                                        </li>
                                    </template>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Submit Button -->
                    <button 
                        type="submit"
                        class="btn btn-primary w-full"
                        :disabled="isLoading || (!message && files.length === 0)">
                        <span class="loading loading-spinner" x-show="isLoading"></span>
                        <span x-text="isLoading ? 'Sending...' : 'Send'"></span>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Initialize HTMX events
    document.body.addEventListener('htmx:afterSwap', function(event) {
        const chatContainer = document.getElementById('chat-container');
        if (chatContainer) {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
    });
</script>
{% endblock %}
